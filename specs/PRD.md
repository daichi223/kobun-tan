# PRD（要件定義） — 記述式クイズの最終判定と訂正システム

## ゴール

1. **記述式を含む古文単語クイズの最終判定（final）を即時確定**
   - 生徒が回答を提出した瞬間に自動採点が行われ、最終判定（final）が即座に確定します
   - 回答は即座に表示され、生徒はフィードバックをすぐに得られます

2. **後から安全に訂正できる仕組み**
   - 教員が誤判定に気づいた場合、個別に訂正できます
   - 同じパターンの回答が複数ある場合、辞書ベースで一括修正できます

3. **訂正手段は「個別上書き」と「辞書ベース一括修正（override）」の2通り**
   - **個別上書き（manual）**: 特定の1回答だけを手動で修正
   - **辞書ベース一括修正（override）**: 同じ正規化キーを持つすべての回答を一括修正

4. **監査性（いつ／誰が／何を変えたか）を担保**
   - すべての訂正操作は履歴として記録されます
   - 誰が、いつ、どのような理由で変更したかを追跡できます

## ユースケース

### 1. 通常の回答フロー

```
生徒が回答 → 自動採点 → final=auto で即時表示
```

### 2. 個別訂正

```
教員が誤りに気づく → /api/overrideAnswer で manual を付与 → final=manual
```

### 3. 一括訂正

```
同型が多い → /api/upsertOverride で override を登録 → final=override に一括反映
```

### 4. ルール更新後の再採点

```
ルールや辞書を更新 → manual のないデータに限り再採点 → /api/rejudge（任意）
```

## 非機能要件

### スケール
- **想定負荷**: 1日数千〜数万回答
- **データストア**: Firestore（コスト効率とスケーラビリティを考慮）

### レイテンシ
- **判定API**: ≤ 200ms（Vercel Functions + Firestore）
- **リアルタイム性**: 生徒は提出後すぐに結果を確認できる

### 監査
- **変更履歴**: すべての訂正は overrides コレクションにイベント記録
- **トレーサビリティ**: 誰が、いつ、何を変更したかを完全に追跡可能

## 表示ルール

### UI表示
- **表示内容**: 常に `answers.final` を表示
- **ソースバッジ**: 判定の由来を明示
  - `auto`: 自動採点
  - `manual`: 個別手動訂正
  - `override`: 辞書ベース一括訂正

### データフロー

```
raw (生データ) → curated (正規化) → manual (手動訂正) → final (最終判定)
                                    ↓
                              override (辞書)
```

## 実装優先順位

### Phase 1: 基盤
- [ ] Firestore スキーマ定義
- [ ] `/api/judge` の final 即時確定
- [ ] 正規化処理の実装

### Phase 2: 訂正機能
- [ ] `/api/overrideAnswer` 実装（個別訂正）
- [ ] `/api/upsertOverride` 実装（一括訂正）
- [ ] 監査ログの記録

### Phase 3: UI
- [ ] 教員向け管理画面
- [ ] 回答一覧と訂正ボタン
- [ ] override 辞書管理

### Phase 4: 運用支援（オプショナル）
- [ ] `/api/rejudge` 実装（再採点）
- [ ] `/api/top-abstain` 実装（要確認候補抽出）
- [ ] ダッシュボード（統計表示）

## 成功基準

1. **正確性**: 自動採点の精度が80%以上
2. **効率性**: 教員が訂正作業を効率的に実行できる
3. **透明性**: すべての変更が監査可能
4. **スケーラビリティ**: 数万回答/日を安定処理
5. **ユーザー体験**: 生徒は即座にフィードバックを得られる
