# 古文クイズアプリケーション 要件定義書

## 1. 概要
本ドキュメントは、古文クイズアプリケーションにおけるユーザー解答の自動採点機能、および関連するUI/UXに関する要件を定義するものである。

本システムは、記述形式で入力されたユーザーの現代語訳を、あらかじめ定義された正解データと照合し、人間の採点感覚に近い精緻な評価とスコアリングを行うことを目的とする。特に、単語が持つ中心的な意味の正誤判断と、助動詞や助詞などが持つ付随的なニュアンスの再現度を分離して評価する。さらに、解答結果に応じたインタラクティブな学習フローを提供することで、ユーザーの主体的で深い学びを促進する。

## 2. システム構成
本システムは、責務の分離の原則に基づき、以下の主要なモジュールで構成される。この構成は、保守性と拡張性を最大化するためのものである。

| ファイル名 | 役割 | 説明 |
|----------|------|------|
| kobun_q.jsonl.txt | 問題データ 📖 | クイズの問題文、例文、および正解の中心的な意味を定義するsenseフィールドを持つ。アプリケーションにおける知識の源泉であり、人間が可読・編集可能な形式を維持する。 |
| morphTokenizer.ts | 形態素解析エンジン 🔬 | 日本語の文字列を、意味の中心を担う**語幹（lemma）**と、文法機能を示す**付属語タグ（aux）**の集合に動的に分解する。現代語の表現揺れ（例：「〜ている」）を古文の文法タグ（例：存続）に正規化する責務も負う。 |
| matchSense.ts | 採点エンジン ✍️ | morphTokenizer.tsによって分解されたユーザー解答と正解データを比較し、後述する精緻な採点アルゴリズムに基づいて0点から100点までのスコアを算出する。本システムの中核ロジック。 |
| App.tsx | アプリケーション本体 🖥️ | UIの表示、ユーザーからの解答受付、各モジュールの呼び出し、そして採点結果とインタラクションの表示など、アプリケーション全体の動作を制御する司令塔。 |
| kobun-grammar.json | 文法ルールブック 🧐 | 直接の採点には関与しないが、解答の文法的な正しさ（例：助動詞の接続規則）を検証し、より詳細で教育的なフィードバックを生成するために参照される補助データ。 |

## 3. 機能要件

### 3.1. 形態素解析機能 (morphTokenizer.ts)
- **入力**: 日本語文字列
- **出力**: `{ lemma: string, aux: string[] }` の形式を持つオブジェクト

**仕様:**
- 入力された文字列から、意味の中心となる**語幹（lemma）**を抽出する
- 助動詞、助詞、活用語尾などを、あらかじめ定義された**付属語タグ（aux）**の配列に変換する
- **現代語表現の正規化**: 現代語の一般的な表現を、古文の文法タグに変換するルールを持つ
  - 例：「〜ている」→ 存続タグ
- **多義性の吸収**: 古文助動詞が持つ複数の意味を、複合タグとして表現する
  - 例：「たり」→ 完了-存続タグ

### 3.2. 採点機能 (matchSense.ts)
- **入力**: ユーザー解答文字列、正解データ文字列 (sense)
- **出力**: 0〜100点の整数スコア、および採点理由を示すステータス

**仕様**: 採点は、**「①語幹の一致度」と「②付属語の一致度」**の2段階で評価する。詳細は以下の「4. 採点アルゴリズム」で定義する。

## 4. 採点アルゴリズム
ユーザー解答は、以下のフローチャートに従って評価され、最初に合致した条件のスコアが最終的な点数となる。

### 4.1. 間違いのパターンとスコア定義

| スコア | 評価パターン | 詳細な条件 | 具体例 (sense → 解答) |
|--------|-------------|-----------|----------------------|
| 0点 | 文脈違い | 解答の語幹が、正解の語幹と全く異なる。単語が持つ複数の意味のうち、文脈に合わないものを選択してしまった場合。 | おどろく (気づく) → 目を覚ます |
| 60点 | 類義語の誤用 | 語幹は異なるが、あらかじめ定義された「意味的に近いが文脈違いの単語リスト」に該当する。 | 心苦し (相手が気の毒だ) → つらい (自分がつらい) |
| 65点 | 必須要素の欠落 | 語幹は一致しているが、訳すべき助動詞や活用語尾が持つ重要な意味（完了、過去、打消など）が完全に欠落している。 | 似たる (完了+存続) → 似る (付属語なし) |
| 75点 | 過剰な解釈 | 語幹と必須の付属語は訳せているが、本来ないはずの余分な意味（可能、尊敬など）を付け加えてしまっている。 | 見えで (打消) → 見られないで (可能+打消) |
| 85点 | 接続部分の欠落 | 語幹と主要な付属語は合っているが、「〜て」「〜で」のような文を繋ぐ機能（接続タグ）のみを訳し忘れている。 | 見えで (打消+接続) → 見ない (打消のみ) |

### 4.2. 正解パターンとスコア定義

| スコア | 評価パターン | 詳細な条件 | 具体例 (sense → 解答) |
|--------|-------------|-----------|----------------------|
| 90点 | 語幹のみ正解 | 問題のsenseと解答の両方に付属語がなく、その中心的な意味を完璧に訳せている。 | あはれなり → しみじみと趣深い |
| 100点 | 完全一致 | 語幹だけでなく、付属語が持つ全てのニュアンス（接続部分も含む）を、過不足なく完璧に訳せている。 | 見えで → 見ないで |

## 5. UIおよびインタラクションフロー要件

### 5.1. 出題形式
**見出し語（lemma）単位での出題:**
- システムは、kobun_q.jsonl.txtから同一の見出し語（lemma）を持つ例文をすべて一度に取得し、1セットの問題としてユーザーに提示する

**例文のランダム表示:**
- 同一見出し語に属する複数の例文は、セッションごとにランダムな順序で表示される

### 5.2. 解答後の画面フロー
**採点結果の表示:**
- ユーザーが解答を提出すると、システムは即座に採点を行い、4.で定義されたスコアを表示する

**自己採点機能の提供:**
- 採点スコアが**60点以上90点以下（60, 65, 75, 85, 90点）**の「部分点」と評価された問題に対して、ユーザーが自身の判断で正誤を修正できる**「〇（正解にする）」「×（不正解にする）」ボタン**を表示する

### 5.3. 次の問題への遷移ロジック
**自動遷移（パーフェクトクリア）:**
- 同一見出し語に属するすべての問題で**100点**を獲得した場合、システムは自動的に次の見出し語の問題セットへ遷移する

**手動遷移（要復習）:**
- 同一見出し語の問題セットのうち、1つでも90点以下のスコアの問題が存在する場合（自己採点で「×」にした場合も含む）、画面下部に**「次へ」ボタン**が表示される
- ユーザーは、自身のペースで解答を確認したのち、手動でボタンを押して次に進む

## 6. データ要件

### 問題データ (kobun_q.jsonl.txt)
- 形式はJSON Lines (.jsonl) とする
- 各行は1つの問題を表現するJSONオブジェクトである
- 必須フィールドとして、問題ID (qid)、見出し語 (lemma)、正解の中心的な意味 (sense) を持つ
- senseフィールドには、形態素に分解する前の、人間が読んで自然な文字列を格納する

### 文法ルールデータ (kobun-grammar.json)
- 形式は単一のJSONオブジェクトとする
- 動詞の活用、助動詞の接続ルールなど、日本語の文法体系を定義する
- App.tsxから参照され、採点後の補助的なフィードバック生成に利用される

## 7. 非機能要件
- **パフォーマンス**: ユーザーの解答提出から採点結果の表示まで、ストレスなく行われること（目標応答時間: 500ms以内）
- **保守性**: 採点基準の変更や、新しい文法ルールの追加が、コードの広範囲な修正を必要とせず、容易に行えること
- **拡張性**: 将来的に、他の種類の問題を追加する際に、既存のモジュールを再利用できる設計であること

## 8. 実装状況（現行システム）

### 8.1. データソース
- `public/kobun500.tsv`: 単語データ
- `public/multiple-meaning-words.tsv`: 多義語データ
- `src/assets/kobun-grammar.json`: 文法規則データ

### 8.2. 現在の採点システム
現在のmatchSense.tsは以下のスコアリングを実装:
- 100%: 厳密一致（括弧・空白除去後）
- 95%: 正規化一致（旧仮名遣い・表記揺れを吸収）
- 90%: 形態素一致（助詞無視、助動詞集合比較）
- 85%: 形態素部分一致（助動詞の部分集合許容）
- 75-80%: 近似一致（Levenshtein距離）

### 8.3. 移行計画
要件定義書に合わせて、以下の実装が必要:
1. **採点アルゴリズムの精緻化**: 語幹と付属語を分離評価するロジック
2. **スコア体系の変更**: 100, 90, 85, 75, 65, 60, 0点の7段階評価
3. **自己採点対象の調整**: 60-90点のみ○×ボタン表示
4. **類義語誤用検出**: 60点判定のための類義語リスト定義
