# ドメイン制限設定手順

## 概要

このアプリケーションは、Google認証により以下の2つのドメインのみアクセスを許可します：
- `@st.spec.ed.jp`
- `@spec.ed.jp`

## 設定済み内容

### 1. 認証システムの変更

**src/auth/firebase.ts**
- 単一ドメインから複数ドメイン対応に変更
- `allowedDomains = ['st.spec.ed.jp', 'spec.ed.jp']`
- ドメインチェック関数を配列対応に修正

**src/auth/AuthGuard.tsx**
- UI表示を2ドメイン対応に更新
- エラーメッセージも両ドメインを表示

### 2. 環境変数設定

**.env.local** （開発環境）
- `VITE_AUTH_REQUIRED=false` - 開発時は認証無効化

**.env.production** （本番環境）
- `VITE_AUTH_REQUIRED=true` - 本番では認証有効化

## Firebase設定手順

### Step 1: Firebase プロジェクト作成

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名を入力（例：kobun-tan-urawa）
4. Google アナリティクスは任意で設定
5. プロジェクト作成完了

### Step 2: Firebase Authentication 設定

1. Firebase Console で「Authentication」を選択
2. 「始める」をクリック
3. 「Sign-in method」タブを選択
4. 「Google」を有効化
   - 「プロジェクトの公開名」を入力
   - 「プロジェクトのサポートメール」を選択
   - 「保存」をクリック

### Step 3: 承認済みドメインの追加

1. Authentication → Settings → 承認済みドメイン
2. 以下のドメインを追加：
   - `st.spec.ed.jp`
   - `spec.ed.jp`
   - （開発用）`localhost`

### Step 4: Firebase 設定情報の取得

1. Firebase Console で「プロジェクトの設定」（歯車アイコン）をクリック
2. 「全般」タブを選択
3. 「マイアプリ」セクションで「ウェブ」アイコンをクリック
4. アプリのニックネームを入力（例：kobun-tan-web）
5. 「Firebase Hosting」は後で設定するため、チェック不要
6. 表示される設定情報をコピー：

```javascript
const firebaseConfig = {
  apiKey: "AIza...",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef..."
};
```

### Step 5: 環境変数ファイルの設定

`.env.production` ファイルを編集し、Firebase設定値を入力：

```env
VITE_FIREBASE_API_KEY=AIza...
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_APP_ID=1:123456789:web:abcdef...
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789

VITE_AUTH_REQUIRED=true
```

## デプロイ手順

### Option A: Firebase Hosting にデプロイ

#### 1. Firebase CLI インストール

```bash
npm install -g firebase-tools
```

#### 2. Firebase ログイン

```bash
firebase login
```

#### 3. Firebase プロジェクト初期化

```bash
firebase init hosting
```

設定項目：
- 既存のプロジェクトを選択
- Public directory: `dist`
- Single-page app: `Yes`
- GitHub自動デプロイ: 任意（`No`でOK）
- 既存の index.html を上書き: `No`

#### 4. ビルドとデプロイ

```bash
npm run build
firebase deploy
```

#### 5. カスタムドメイン設定

1. Firebase Console → Hosting → ドメインを追加
2. `st.spec.ed.jp` を入力
3. 表示される DNS レコードをドメイン管理画面で設定：
   - A レコード: `151.101.1.195`, `151.101.65.195`
   - TXT レコード: `firebase=...`（所有権確認用）
4. 同様に `spec.ed.jp` も追加

### Option B: GitHub Pages にデプロイ

#### 1. リポジトリ設定

GitHub リポジトリの Settings → Pages で設定

#### 2. カスタムドメイン設定

1. リポジトリの `public/` に `CNAME` ファイルを作成
2. ドメイン名を記入（例：`st.spec.ed.jp`）
3. DNS設定で以下を追加：
   - A レコード: GitHub Pages の IP
   - CNAME レコード: `your-username.github.io`

### Option C: Vercel にデプロイ

#### 1. Vercel CLI インストール

```bash
npm install -g vercel
```

#### 2. デプロイ

```bash
vercel
```

#### 3. 環境変数設定

Vercel Dashboard で環境変数を追加（`.env.production` の内容）

#### 4. カスタムドメイン追加

Vercel Dashboard → Settings → Domains でドメイン追加

## DNS 設定例

### st.spec.ed.jp

| タイプ | 名前 | 値 |
|--------|------|-----|
| A | @ | Firebase/Vercel の IP |
| TXT | @ | firebase=... (所有権確認) |

### spec.ed.jp

| タイプ | 名前 | 値 |
|--------|------|-----|
| A | @ | Firebase/Vercel の IP |
| TXT | @ | firebase=... (所有権確認) |

## テスト手順

### 開発環境（認証無効）

```bash
npm run dev
```

- 認証なしで動作確認

### 本番環境（認証有効）

```bash
npm run build
npm run preview
```

- Google ログイン画面が表示される
- `@st.spec.ed.jp` または `@spec.ed.jp` でログイン成功
- それ以外のドメインはエラー表示

## トラブルシューティング

### 認証が無効のまま

- `.env.production` で `VITE_AUTH_REQUIRED=true` になっているか確認
- `npm run build` で再ビルドしたか確認

### ドメインエラーが出る

- Firebase Console の承認済みドメインに追加されているか確認
- DNS設定が正しいか確認（伝播に24-48時間かかる場合あり）

### ログインできない

- Firebase Authentication が有効になっているか確認
- Google プロバイダーが有効化されているか確認
- `.env.production` の設定値が正しいか確認

## セキュリティ注意事項

⚠️ **重要**

1. `.env.production` は `.gitignore` に含まれています
2. Firebase 設定値は公開されても問題ありませんが、念のため管理に注意
3. 本番環境では必ず `VITE_AUTH_REQUIRED=true` に設定
4. Firebase セキュリティルールも適切に設定してください

## 参考資料

- [Firebase Authentication ドキュメント](https://firebase.google.com/docs/auth)
- [Firebase Hosting ドキュメント](https://firebase.google.com/docs/hosting)
- [Vite 環境変数](https://vitejs.dev/guide/env-and-mode.html)
